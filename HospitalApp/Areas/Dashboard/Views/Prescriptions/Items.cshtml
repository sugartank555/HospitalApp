@{
    Layout = "~/Areas/Dashboard/Views/Shared/_DashboardLayout.cshtml";

    var pres = (HospitalApp.Models.Prescription)ViewBag.Prescription;
    var items = (IEnumerable<HospitalApp.Models.MedicineOfPrescription>)ViewBag.Items;

    ViewData["Title"] = $"Thuốc của toa #{pres.Id}";
    Func<decimal, string> fmtMoney = v => v.ToString("N0") + " VNĐ";
}

<div class="card shadow-sm border-0 mb-4">

    <!-- Header -->
    <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between flex-wrap gap-2">
        <div>
            <h3 class="fw-bold m-0">
                <i class="fas fa-prescription-bottle-alt text-primary me-2"></i>
                @ViewData["Title"]
            </h3>
            <p class="text-muted mt-1">Quản lý danh sách thuốc của toa thuốc</p>
        </div>

        <div class="d-flex gap-2 align-items-center">
            <a class="btn btn-light border" asp-action="Index">
                <i class="fas fa-arrow-left me-1"></i> Danh sách toa
            </a>
            <a class="btn btn-outline-info" asp-action="Details" asp-route-id="@pres.Id">
                <i class="fas fa-eye me-1"></i> Xem chi tiết toa
            </a>
        </div>
    </div>

    <!-- Add Medicine -->
    <div class="card-body px-4 pb-4">

        <div class="p-3 mb-4 rounded-3 border bg-light">
            <h5 class="fw-bold mb-3"><i class="fas fa-pills me-2 text-primary"></i>Thêm thuốc vào toa</h5>

            <form method="post" asp-action="AddItem" class="row g-3">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@pres.Id" />

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Tên thuốc</label>
                    <select name="medicineId" class="form-select form-select-lg" asp-items="ViewBag.MedicineId"></select>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Hướng dẫn sử dụng</label>
                    <input name="note" type="text" class="form-control form-control-lg" placeholder="VD: Uống sau ăn, ngày 2 lần..." />
                </div>


                <div class="col-md-3 d-grid">
                    <label class="form-label invisible">.</label>
                    <button class="btn btn-primary btn-lg">
                        <i class="fas fa-plus me-1"></i> Thêm
                    </button>
                </div>
            </form>
        </div>

        <!-- List -->
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white fw-semibold d-flex justify-content-between align-items-center">
                <span><i class="fas fa-list me-2"></i>Danh sách thuốc trong toa</span>
                <span class="badge bg-primary">Tổng mục: @(items?.Count() ?? 0)</span>
            </div>

            @if (items == null || !items.Any())
            {
                <div class="card-body">
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-1"></i> Toa chưa có thuốc. Hãy thêm thuốc phía trên.
                    </div>
                </div>
            }
            else
            {
                <div class="table-responsive" style="max-height: 60vh; overflow:auto;">
                    <table class="table table-striped align-middle mb-0">
                        <thead class="table-light position-sticky top-0">
                            <tr>
                                <th style="width:64px">#</th>
                                <th>Tên thuốc</th>
                                <th style="width:160px;">Đơn giá</th>
                                <th style="width:180px;">Số lượng</th>
                                <th style="width:180px;">Tạm tính</th>
                                <th class="text-end" style="width:140px;"></th>
                            </tr>
                        </thead>

                        <tbody>
                            @{
                                decimal total = 0m;
                                int idx = 1;
                                foreach (var it in items)
                                {
                                    var price = it.Medicine?.Price ?? 0m;
                                    var qty = it.Quantity;
                                    var sub = price * qty;
                                    total += sub;
                                    <tr>
                                        <td>@idx</td>
                                        <td>@it.Medicine?.Name</td>
                                        <td>@fmtMoney(price)</td>

                                        <td>
                                            <form method="post" asp-action="UpdateItem" class="d-flex gap-2">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@pres.Id" />
                                                <input type="hidden" name="medicineId" value="@it.MedicineId" />

                                                <input name="quantity" type="number"
                                                       class="form-control form-control-sm"
                                                       min="1" value="@qty" />

                                                <button class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-save"></i>
                                                </button>
                                            </form>
                                        </td>

                                        <td>@fmtMoney(sub)</td>

                                        <td class="text-end">
                                            <form method="post" asp-action="RemoveItem"
                                                  onsubmit="return confirm('Xoá thuốc này khỏi toa?');"
                                                  class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@pres.Id" />
                                                <input type="hidden" name="medicineId" value="@it.MedicineId" />

                                                <button class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    idx++;
                                }
                            }
                        </tbody>

                        <tfoot class="table-light">
                            <tr>
                                <th colspan="4" class="text-end">Tổng cộng</th>
                                <th colspan="2" class="fw-bold">@fmtMoney(total)</th>
                            </tr>
                        </tfoot>


                    </table>
                </div>
            }                 
        </div>
        <a class="btn btn-warning" asp-action="PrintItems" asp-route-id="@pres.Id" target="_blank">
            <i class="fas fa-print"></i> In danh sách thuốc
        </a>
    </div>
</div>
