@{
    Layout = "~/Areas/Dashboard/Views/Shared/_DashboardLayout.cshtml";
    var pres = (HospitalApp.Models.Prescription)ViewBag.Prescription;
    var items = (IEnumerable<HospitalApp.Models.MedicineOfPrescription>)ViewBag.Items;
    ViewData["Title"] = $"Thuốc của toa #{pres.Id}";
    Func<decimal, string> fmtMoney = v => v.ToString("N0") + " VNĐ";
}

<h2 class="mb-3">@ViewData["Title"]</h2>

<div class="mb-3 d-flex gap-2 flex-wrap">
    <a class="btn btn-secondary" asp-action="Index">← Danh sách toa</a>
    <a class="btn btn-outline-info" asp-action="Details" asp-route-id="@pres.Id">Xem chi tiết toa</a>
</div>

<div class="card mb-4">
    <div class="card-header fw-semibold">Thêm thuốc</div>
    <div class="card-body">
        <form method="post" asp-action="AddItem" class="row g-2 align-items-end">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" value="@pres.Id" />

            <div class="col-lg-6">
                <label class="form-label">Thuốc</label>
                <select name="medicineId" class="form-select" asp-items="ViewBag.MedicineId"></select>
            </div>

            <div class="col-sm-6 col-lg-3">
                <label class="form-label">Số lượng</label>
                <input name="quantity" type="number" class="form-control" value="1" min="1" />
            </div>

            <div class="col-sm-6 col-lg-3">
                <button class="btn btn-primary w-100">
                    <i class="fas fa-plus me-1"></i> Thêm
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
        <span>Danh sách thuốc</span>
        <span class="badge bg-primary">Tổng mục: @(items?.Count() ?? 0)</span>
    </div>

    @if (items == null || !items.Any())
    {
        <div class="card-body">
            <div class="alert alert-info mb-0">Toa chưa có thuốc. Hãy thêm thuốc ở bên trên.</div>
        </div>
    }
    else
    {
        <div class="table-responsive" style="max-height: 60vh; overflow:auto;">
            <table class="table table-striped align-middle mb-0">
                <thead class="table-light position-sticky top-0">
                    <tr>
                        <th style="width:64px">#</th>
                        <th>Tên thuốc</th>
                        <th style="width:160px;">Đơn giá</th>
                        <th style="width:180px;">Số lượng</th>
                        <th style="width:180px;">Tạm tính</th>
                        <th style="width:140px;"></th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        decimal total = 0m;
                        int idx = 1;
                        foreach (var it in items)
                        {
                            var price = it.Medicine?.Price ?? 0m;
                            var qty = it.Quantity; // model cần có Quantity (int)
                            var sub = price * qty;
                            total += sub;
                            <tr>
                                <td>@idx</td>
                                <td>@it.Medicine?.Name</td>
                                <td>@fmtMoney(price)</td>
                                <td>
                                    <form method="post" asp-action="UpdateItem" class="d-flex gap-2">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@pres.Id" />
                                        <input type="hidden" name="medicineId" value="@it.MedicineId" />
                                        <input name="quantity" type="number" class="form-control form-control-sm"
                                               value="@qty" min="1" />
                                        <button class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-save"></i> Cập nhật
                                        </button>
                                    </form>
                                </td>
                                <td>@fmtMoney(sub)</td>
                                <td class="text-nowrap">
                                    <form method="post" asp-action="RemoveItem"
                                          onsubmit="return confirm('Xoá thuốc này khỏi toa?');" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@pres.Id" />
                                        <input type="hidden" name="medicineId" value="@it.MedicineId" />
                                        <button class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash-alt"></i> Xoá
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            idx++;
                        }
                    }
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th colspan="4" class="text-end">Tổng cộng</th>
                        <th colspan="2" class="fw-bold">@fmtMoney(total)</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    }
</div>
