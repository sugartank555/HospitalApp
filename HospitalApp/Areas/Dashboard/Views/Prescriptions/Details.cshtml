@model HospitalApp.Models.Prescription
@{
    Layout = "~/Areas/Dashboard/Views/Shared/_DashboardLayout.cshtml";
    var items = (IEnumerable<HospitalApp.Models.MedicineOfPrescription>)ViewBag.Items;
    Func<decimal, string> fmtMoney = v => v.ToString("N0") + " VNĐ";
}

<div class="card shadow-sm border-0 mb-4">

    <!-- Header -->
    <div class="card-header bg-white pt-4 pb-3 px-4 border-0">
        <h3 class="fw-bold m-0">
            <i class="fas fa-file-prescription text-primary me-2"></i>
            Chi tiết toa thuốc #@Model.Id
        </h3>
        <p class="text-muted mt-1">
            Thông tin chi tiết và danh sách thuốc trong toa
        </p>
    </div>

    <div class="card-body px-4">

        <!-- Prescription Info -->
        <dl class="row mb-0">
            <dt class="col-sm-3 fw-semibold text-secondary">Hồ sơ khám</dt>
            <dd class="col-sm-9">@Model.MedicalRecordId</dd>

            <dt class="col-sm-3 fw-semibold text-secondary">Ngày lập</dt>
            <dd class="col-sm-9">@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</dd>
        </dl>
    </div>
</div>


<!-- Medicine List -->
<div class="card shadow-sm border-0">

    <div class="card-header bg-white d-flex justify-content-between align-items-center px-4 py-3 border-0">
        <h5 class="fw-semibold mb-0">
            <i class="fas fa-pills text-primary me-2"></i>
            Thuốc trong toa
        </h5>

        <a class="btn btn-sm btn-outline-success" asp-action="Items" asp-route-id="@Model.Id">
            <i class="fas fa-plus me-1"></i> Thêm thuốc
        </a>
    </div>

    @if (items == null || !items.Any())
    {
        <div class="card-body">
            <div class="alert alert-info mb-0">
                Toa thuốc chưa có thuốc nào.
            </div>
        </div>
    }
    else
    {
        <div class="table-responsive" style="max-height: 65vh; overflow:auto;">
            <table class="table table-striped align-middle mb-0">
                <thead class="table-light position-sticky top-0">
                    <tr>
                        <th style="width:60px">#</th>
                        <th>Tên thuốc</th>
                        <th style="width:160px;">Đơn giá</th>
                        <th style="width:140px;">Số lượng</th>
                        <th style="width:160px;">Tạm tính</th>
                    </tr>
                </thead>

                <tbody>
                    @{
                        int index = 1;
                        decimal total = 0m;

                        foreach (var it in items)
                        {
                            var price = it.Medicine?.Price ?? 0m;
                            var qty = it.Quantity;
                            var sub = price * qty;
                            total += sub;

                            <tr>
                                <td>@index</td>
                                <td>@it.Medicine?.Name</td>
                                <td>@fmtMoney(price)</td>
                                <td>@qty</td>
                                <td class="fw-semibold">@fmtMoney(sub)</td>
                            </tr>
                            ;

                            index++;
                        }
                    }
                </tbody>

                <tfoot class="table-light">
                    <tr>
                        <th colspan="4" class="text-end">Tổng cộng</th>
                        <th class="fw-bold text-primary">@fmtMoney(total)</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    }
</div>

<div class="mt-4">
    <a class="btn btn-secondary" asp-action="Index">
        <i class="fas fa-arrow-left me-1"></i> Về danh sách
    </a>
</div>
<div class="mt-3">
    <a class="btn btn-outline-primary"
       asp-action="PrintInvoice"
       asp-route-id="@Model.Id"
       target="_blank">
        <i class="fas fa-print me-1"></i> In hóa đơn
    </a>
</div>

