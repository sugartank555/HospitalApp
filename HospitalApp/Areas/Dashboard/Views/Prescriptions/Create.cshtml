@model HospitalApp.Models.Prescription

@{
    ViewData["Title"] = "Tạo đơn thuốc";
    var mrList = (SelectList)ViewData["MedicalRecordId"];
}

<div class="card shadow-sm border-0 mt-2">

    <!-- Header -->
    <div class="card-header bg-white border-0 pt-4 px-4 pb-3">
        <h3 class="fw-bold m-0">
            <i class="fas fa-prescription text-primary me-2"></i>
            @ViewData["Title"]
        </h3>
        <p class="text-muted mt-1">Chọn hồ sơ khám và tạo đơn thuốc mới</p>
    </div>

    <!-- Body -->
    <div class="card-body px-4 pb-4">

        <form method="post">
            @Html.AntiForgeryToken()

            <!-- MedicalRecord selector -->
            <div class="mb-3">
                <label class="form-label fw-semibold">
                    <i class="fas fa-file-medical me-1 text-secondary"></i> Hồ sơ khám
                </label>

                <select id="mrSelect"
                        name="MedicalRecordId"
                        class="form-select form-select-lg"
                        asp-items="mrList"
                        required>
                    <option value="">— Chọn hồ sơ khám —</option>
                </select>
            </div>

            <!-- Auto fill area -->
            <div id="mrInfo"
                 class="p-3 rounded shadow-sm bg-light border mt-3"
                 style="display:none;">

                <h6 class="fw-bold text-primary mb-2">
                    <i class="fas fa-info-circle me-1"></i>
                    Thông tin hồ sơ khám
                </h6>
                <hr class="mt-1 mb-3" />

                <div class="row g-3">

                    <div class="col-md-6">
                        <label class="small text-muted">Bệnh nhân</label>
                        <div id="mrPatient" class="fw-semibold"></div>
                    </div>

                    <div class="col-md-3">
                        <label class="small text-muted">Ngày khám</label>
                        <div id="mrDate" class="fw-semibold"></div>
                    </div>

                    <div class="col-md-3">
                        <label class="small text-muted">Bác sĩ điều trị</label>
                        <div id="mrDoctor" class="fw-semibold"></div>
                    </div>

                    <div class="col-12">
                        <label class="small text-muted">Triệu chứng</label>
                        <div id="mrSymptom"></div>
                    </div>

                    <div class="col-12">
                        <label class="small text-muted">Chẩn đoán</label>
                        <div id="mrDiagnosis"></div>
                    </div>

                    <div class="col-12">
                        <label class="small text-muted">Hướng điều trị</label>
                        <div id="mrTreatment"></div>
                    </div>

                </div>
            </div>

            <hr class="my-4" />

            <!-- Footer buttons -->
            <div class="text-end">
                <button type="submit" class="btn btn-primary px-4">
                    <i class="fas fa-save me-1"></i> Tạo đơn thuốc
                </button>
                <a asp-action="Index" class="btn btn-secondary px-3 ms-2">
                    <i class="fas fa-arrow-left me-1"></i> Quay lại
                </a>
            </div>

        </form>

    </div>
</div>

@section Scripts {
    <script>
        // Khi chọn MedicalRecordId -> gọi API lấy thông tin MR
        $("#mrSelect").change(function () {
            let id = $(this).val();

            if (!id) {
                $("#mrInfo").hide();
                return;
            }

            $.get(`/Dashboard/MedicalRecords/GetInfo/${id}`, function (data) {

                if (!data) return;

                $("#mrPatient").text(data.patient);
                $("#mrDate").text(data.date);
                $("#mrDoctor").text(data.doctor);
                $("#mrSymptom").text(data.symptom);
                $("#mrDiagnosis").text(data.diagnosis);
                $("#mrTreatment").text(data.treatment);

                $("#mrInfo").slideDown();
            });
        });
    </script>
}
